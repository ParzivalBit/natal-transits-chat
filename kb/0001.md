# Repository Knowledge Base (chunk 0001)


## File: backups\db-schema.json

```json
[
  {
    "schema_json": {
      "schemas": [
        {
          "name": "public",
          "tables": [
            {
              "name": "birth_data",
              "columns": [
                {
                  "name": "id",
                  "type": "bigint",
                  "default": "nextval('birth_data_id_seq'::regclass)",
                  "nullable": false
                },
                {
                  "name": "user_id",
                  "type": "uuid",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "name",
                  "type": "text",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "date",
                  "type": "date",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "time",
                  "type": "time without time zone",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "tz_offset_minutes",
                  "type": "integer",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "place_name",
                  "type": "text",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "lat",
                  "type": "double precision",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "lon",
                  "type": "double precision",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "default": "now()",
                  "nullable": false
                }
              ],
              "primary_key": [
                "id"
              ],
              "foreign_keys": [
                {
                  "name": "birth_data_user_id_fkey",
                  "columns": [
                    "user_id"
                  ],
                  "ref_table": "auth.users",
                  "ref_columns": [
                    "id"
                  ]
                }
              ]
            },
            {
              "name": "chart_points",
              "columns": [
                {
                  "name": "id",
                  "type": "bigint",
                  "default": "nextval('chart_points_id_seq'::regclass)",
                  "nullable": false
                },
                {
                  "name": "user_id",
                  "type": "uuid",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "kind",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "name",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "longitude",
                  "type": "numeric(7,3)",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "sign",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "house",
                  "type": "integer",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "retro",
                  "type": "boolean",
                  "default": "false",
                  "nullable": true
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "default": "now()",
                  "nullable": false
                }
              ],
              "primary_key": [
                "id"
              ],
              "foreign_keys": []
            },
            {
              "name": "chat_messages",
              "columns": [
                {
                  "name": "id",
                  "type": "bigint",
                  "default": "nextval('chat_messages_id_seq'::regclass)",
                  "nullable": false
                },
                {
                  "name": "session_id",
                  "type": "uuid",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "role",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "content",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "default": "now()",
                  "nullable": false
                }
              ],
              "primary_key": [
                "id"
              ],
              "foreign_keys": [
                {
                  "name": "chat_messages_session_id_fkey",
                  "columns": [
                    "session_id"
                  ],
                  "ref_table": "public.chat_sessions",
                  "ref_columns": [
                    "id"
                  ]
                }
              ]
            },
            {
              "name": "chat_sessions",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "default": "gen_random_uuid()",
                  "nullable": false
                },
                {
                  "name": "user_id",
                  "type": "uuid",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "default": "now()",
                  "nullable": false
                }
              ],
              "primary_key": [
                "id"
              ],
              "foreign_keys": []
            },
            {
              "name": "house_cusps",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "default": "gen_random_uuid()",
                  "nullable": false
                },
                {
                  "name": "user_id",
                  "type": "uuid",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "system",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "cusp",
                  "type": "integer",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "longitude",
                  "type": "double precision",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "default": "now()",
                  "nullable": false
                }
              ],
              "primary_key": [
                "id"
              ],
              "foreign_keys": [
                {
                  "name": "house_cusps_user_id_fkey",
                  "columns": [
                    "user_id"
                  ],
                  "ref_table": "auth.users",
                  "ref_columns": [
                    "id"
                  ]
                }
              ]
            },
            {
              "name": "interpretations",
              "columns": [
                {
                  "name": "id",
                  "type": "bigint",
                  "default": "nextval('interpretations_id_seq'::regclass)",
                  "nullable": false
                },
                {
                  "name": "type",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "key",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "title",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "summary",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "tips",
                  "type": "jsonb",
                  "default": "'[]'::jsonb",
                  "nullable": false
                }
              ],
              "primary_key": [
                "id"
              ],
              "foreign_keys": []
            },
            {
              "name": "natal_aspects",
              "columns": [
                {
                  "name": "id",
                  "type": "bigint",
                  "default": "nextval('natal_aspects_id_seq'::regclass)",
                  "nullable": false
                },
                {
                  "name": "user_id",
                  "type": "uuid",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "p1",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "p2",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "aspect",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "orb",
                  "type": "numeric(5,2)",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "strength",
                  "type": "numeric(6,2)",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "default": "now()",
                  "nullable": false
                }
              ],
              "primary_key": [
                "id"
              ],
              "foreign_keys": []
            },
            {
              "name": "people",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "default": "gen_random_uuid()",
                  "nullable": false
                },
                {
                  "name": "user_id",
                  "type": "uuid",
                  "default": "auth.uid()",
                  "nullable": false
                },
                {
                  "name": "label",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "birth_date",
                  "type": "date",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "birth_time",
                  "type": "time without time zone",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "birth_tz_name",
                  "type": "text",
                  "default": "'UTC'::text",
                  "nullable": false
                },
                {
                  "name": "birth_tz_offset_minutes",
                  "type": "integer",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "birth_place_name",
                  "type": "text",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "birth_lat",
                  "type": "double precision",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "birth_lon",
                  "type": "double precision",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "default": "now()",
                  "nullable": false
                }
              ],
              "primary_key": [
                "id"
              ],
              "foreign_keys": [
                {
                  "name": "people_user_id_fkey",
                  "columns": [
                    "user_id"
                  ],
                  "ref_table": "auth.users",
                  "ref_columns": [
                    "id"
                  ]
                }
              ]
            },
            {
              "name": "people_chart_points",
              "columns": [
                {
                  "name": "id",
                  "type": "bigint",
                  "default": "nextval('people_chart_points_id_seq'::regclass)",
                  "nullable": false
                },
                {
                  "name": "person_id",
                  "type": "uuid",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "name",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "longitude",
                  "type": "double precision",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "sign",
                  "type": "text",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "house",
                  "type": "integer",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "retro",
                  "type": "boolean",
                  "default": "false",
                  "nullable": false
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "default": "now()",
                  "nullable": false
                }
              ],
              "primary_key": [
                "id"
              ],
              "foreign_keys": [
                {
                  "name": "people_chart_points_person_id_fkey",
                  "columns": [
                    "person_id"
                  ],
                  "ref_table": "public.people",
                  "ref_columns": [
                    "id"
                  ]
                }
              ]
            },
            {
              "name": "people_house_cusps",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "default": "gen_random_uuid()",
                  "nullable": false
                },
                {
                  "name": "person_id",
                  "type": "uuid",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "system",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "cusp",
                  "type": "smallint",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "longitude",
                  "type": "numeric",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "default": "now()",
                  "nullable": false
                }
              ],
              "primary_key": [
                "id"
              ],
              "foreign_keys": [
                {
                  "name": "people_house_cusps_person_id_fkey",
                  "columns": [
                    "person_id"
                  ],
                  "ref_table": "public.people",
                  "ref_columns": [
                    "id"
                  ]
                }
              ]
            },
            {
              "name": "people_natal_aspects",
              "columns": [
                {
                  "name": "id",
                  "type": "bigint",
                  "default": "nextval('people_natal_aspects_id_seq'::regclass)",
                  "nullable": false
                },
                {
                  "name": "person_id",
                  "type": "uuid",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "p1",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "p2",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "aspect",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "orb",
                  "type": "double precision",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "strength",
                  "type": "double precision",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "default": "now()",
                  "nullable": false
                }
              ],
              "primary_key": [
                "id"
              ],
              "foreign_keys": [
                {
                  "name": "people_natal_aspects_person_id_fkey",
                  "columns": [
                    "person_id"
                  ],
                  "ref_table": "public.people",
                  "ref_columns": [
                    "id"
                  ]
                }
              ]
            },
            {
              "name": "synastry_aspects",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "default": "gen_random_uuid()",
                  "nullable": false
                },
                {
                  "name": "user_id",
                  "type": "uuid",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "person_id",
                  "type": "uuid",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "p1_name",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "p1_owner",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "p2_name",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "p2_owner",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "aspect",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "angle",
                  "type": "numeric",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "orb",
                  "type": "numeric",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "applying",
                  "type": "boolean",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "score",
                  "type": "numeric",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "default": "now()",
                  "nullable": false
                },
                {
                  "name": "min_name",
                  "type": "text",
                  "default": "LEAST(p1_name, p2_name)",
                  "nullable": true
                },
                {
                  "name": "max_name",
                  "type": "text",
                  "default": "GREATEST(p1_name, p2_name)",
                  "nullable": true
                }
              ],
              "primary_key": [
                "id"
              ],
              "foreign_keys": [
                {
                  "name": "synastry_aspects_person_id_fkey",
                  "columns": [
                    "person_id"
                  ],
                  "ref_table": "public.people",
                  "ref_columns": [
                    "id"
                  ]
                },
                {
                  "name": "synastry_aspects_user_id_fkey",
                  "columns": [
                    "user_id"
                  ],
                  "ref_table": "auth.users",
                  "ref_columns": [
                    "id"
                  ]
                }
              ]
            },
            {
              "name": "transit_events",
              "columns": [
                {
                  "name": "id",
                  "type": "bigint",
                  "default": "nextval('transit_events_id_seq'::regclass)",
                  "nullable": false
                },
                {
                  "name": "user_id",
                  "type": "uuid",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "date",
                  "type": "date",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "t_planet",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "n_point",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "aspect",
                  "type": "text",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "orb",
                  "type": "numeric(5,2)",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "score",
                  "type": "numeric(7,3)",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "default": "now()",
                  "nullable": false
                }
              ],
              "primary_key": [
                "id"
              ],
              "foreign_keys": []
            },
            {
              "name": "user_birth_data",
              "columns": [
                {
                  "name": "user_id",
                  "type": "uuid",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "birth_datetime_utc",
                  "type": "timestamp with time zone",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "latitude",
                  "type": "double precision",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "longitude",
                  "type": "double precision",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "default": "now()",
                  "nullable": false
                },
                {
                  "name": "updated_at",
                  "type": "timestamp with time zone",
                  "default": "now()",
                  "nullable": false
                }
              ],
              "primary_key": [
                "user_id"
              ],
              "foreign_keys": [
                {
                  "name": "user_birth_data_user_id_fkey",
                  "columns": [
                    "user_id"
                  ],
                  "ref_table": "auth.users",
                  "ref_columns": [
                    "id"
                  ]
                }
              ]
            },
            {
              "name": "user_prefs",
              "columns": [
                {
                  "name": "user_id",
                  "type": "uuid",
                  "default": null,
                  "nullable": false
                },
                {
                  "name": "current_place_name",
                  "type": "text",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "current_lat",
                  "type": "double precision",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "current_lon",
                  "type": "double precision",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "current_tz_name",
                  "type": "text",
                  "default": null,
                  "nullable": true
                },
                {
                  "name": "updated_at",
                  "type": "timestamp with time zone",
                  "default": "now()",
                  "nullable": true
                },
                {
                  "name": "house_system",
                  "type": "text",
                  "default": "'whole'::text",
                  "nullable": false
                }
              ],
              "primary_key": [
                "user_id"
              ],
              "foreign_keys": [
                {
                  "name": "user_prefs_user_id_fkey",
                  "columns": [
                    "user_id"
                  ],
                  "ref_table": "auth.users",
                  "ref_columns": [
                    "id"
                  ]
                }
              ]
            }
          ]
        }
      ]
    }
  }
]
```


## File: backups\PROJECT_OVERIVIEW_25_9.MD

Natal Transit AI — Guida alla Codebase (per ChatGPT)

Questo documento descrive a cosa serve ogni file, dove viene usato, come interagisce col DB Supabase e quali moduli richiama, basandosi sulla KB allegata e sullo schema db-schema.json. È pensato per essere allegato alla codebase e usato come contesto iniziale in una nuova chat.

1) Mappa generale del repository

La KB elenca tutti i path e le dimensioni: consulta _INDEX.md per l’inventario completo dei file (Next.js App Router, API Routes, componenti, librerie interne, script).

Stack principale e script (dev, build, export:kb, docs:schema) sono in package.json. Dipendenze core: next@14, react@18, astronomy-engine, @supabase/*, luxon, zod.

2) Frontend — Pagine (App Router)
src/app/layout.tsx

Layout globale (intestazione, footer, disclaimer); styling via globals.css.

src/app/page.tsx

Landing con CTA verso /dashboard o /onboarding se non autenticato. Legge lo user con Supabase SSR client.

src/app/chat/page.tsx

Pagina Chat semplice che monta <ChatUI /> (interfaccia verso /api/chat).

src/app/onboarding/page.tsx

Flusso di onboarding: se non loggato mostra <AuthForm />. Se loggato legge da DB:

birth_data (name, date, time, place, lat, lon) per i dati di nascita,

user_prefs (current location, timezone, house_system) per preferenze,
e mostra <BirthSection /> e <CurrentLocationForm />. Scrive/legge da birth_data e user_prefs tramite form+API.

Dashboard (macro-sezioni)

L’indice della KB elenca le pagine /dashboard: natal, transits (giornalieri e mensili), daily sky, moon, people/sinastria; tutte leggono preferenze/cuspidi/posizioni e forniscono contesto al chatbot.

Esempio “daily” (cielo del giorno): src/app/dashboard/daily/page.tsx importa computePoints da lib/astro e visualizza con SkyWheel. Fornisce i pianeti del giorno e metadati (segno, casa, retro) calcolati a runtime; la pagina è protetta (redirect se non autenticati).

3) Frontend — Componenti UI/Chart
src/components/SkyWheel.tsx

Ruota “cielo del giorno”. Input: array di punti (name, longitude, sign, house, retro). Output: SVG/HTML assoluto con tacche dei segni e badge con glifi planetari; 0° in alto, orientamento coerente. Niente scritture DB: è puro rendering.

src/components/astro/ChartWheelPro.tsx

Ruota tema natale (Pro) con:

calcolo aspetti natali (conjunction, opposition, trine, square, sextile; orb 6° default),

collision avoidance delle etichette,

assi ASC/MC derivati da cusps o passati via props,

rotazione per avere l’ASC a sinistra (≈270°),

evidenziazione interattiva pianeti/linee di aspetto. Nessuna I/O DB: consumo dati già calcolati.

src/components/astro/_parts.tsx

Libreria di parti SVG riutilizzabili per le ruote “Pro”:

ZodiacRingPro, HousesRingPro, PlanetGlyphsPro, AspectLinesStraightToday, AspectGuides.
Definisce glifi, palette CSS, utilities polari, e aspetti con colori standard. Nessuna I/O DB.

src/components/TransitsPanel.tsx

Pannello “Transits” (client) che:

calcola pianeti in transito con computeDailyPlanets(dateUTC),

assegna le case natali dei transiti tramite assignHouses(p.longitude, natalCusps) (Placidus-safe),

genera Top 3 transiti giorno ↔ punti natali via matching aspetti e orbi standard,

renderizza con ChartWheel (ruota classica) + lista ranking.
Niente scritture DB; legge cuspidi/punti natali passati come props dal server.

src/components/PeoplePanel.tsx

Form server action per creare/aggiornare “persona” destinata alla sinastria:

Upsert in people (id, user_id, label, birth_*).

Geocoding on-save (Nominatim) se mancano birth_lat/lon, poi update di people.

Calcola pianeti natalizi (usando computeDailyPlanets(dateUTC) come base) e popola people_chart_points (solo person_id, no user_id).

Revalidate e redirect a /lab/people-pro/[id].

4) Pagine “Lab” (sandbox grafica)
src/app/lab/transits-pro/page.tsx + ClientTransitsPro.tsx

Ambiente di prova per la ruota transiti “Pro”:

carica i pianeti di oggi via computeDailyPlanets(nowUTC),

carica i punti natali utente da chart_points (DB) se loggato,

calcola le cuspidi natalizie a runtime via computeHousesForDateUTC({system, dateUTC, latDeg, lonDeg}) leggendo user_prefs.house_system e birth_data (fallback se mancano dati),

UI controlli: toggle aspetti e orb offset; monta <TransitsWheelPro />.
Letture DB: chart_points, user_prefs, birth_data. Nessuna scrittura.

Nota: la cartella /lab serve a testare componenti nuovi (…Pro) senza toccare i file di produzione.

5) Backend — API Routes

L’elenco completo è in _INDEX.md; di seguito i più rilevanti.

Auth

src/app/api/auth/set-session/route.ts: imposta cookie sessione da token (Supabase SSR route client).

src/app/auth/callback/route.ts: scambia code → sessione (PKCE/Email OTP), redirect a /onboarding#birth.

src/app/api/auth/signout/route.ts: supabase.auth.signOut(), risponde JSON.

Utente / Preferenze

src/app/api/user/prefs/route.ts: upsert user_prefs (house_system, current_*); no lettura di massa.

Astro/Calcolo & Persistenza

src/app/api/chart/compute/route.ts: endpoint centrale (nella KB/overview) che calcola posizioni, case e scrive su birth_data, chart_points, natal_aspects, e (se previsto) house_cusps. Viene citato come fulcro del flusso onboarding → compute.

src/app/api/transits/route.ts e src/app/api/transits/month/route.ts: calcolo transiti “oggi” e “mese” (astronomy-engine, ranking con punteggi/orbi). Senza persistenza.

Chatbot e testi

src/app/api/chat/route.ts: costruisce il contesto (preferenze/case da user_prefs+house_cusps, natal da chart_points, transiti odierni, eventuale contesto UI), chiama OpenAI e salva cronologia in chat_sessions/chat_messages.

src/app/api/interpret/natal/route.ts e src/app/api/interpret/transits/route.ts: componitori di testi interpretativi (pipeline lib/composer), solo letture da interpretations e dati utente, nessuna scrittura.

People (sinastria)

src/app/api/people/route.ts (GET/POST) e [id]/route.ts: CRUD base su people + popolamento people_chart_points/people_natal_aspects.

Servizi

src/app/api/geo/resolve + search: geocoding (Nominatim) e ricerca località; nessuna persistenza.

src/app/api/calendar/ics/route.ts: genera ICS on-the-fly, nessuna persistenza.

src/app/api/ping/route.ts: healthcheck.

6) Librerie interne (/lib)
src/lib/planets/runtime.ts

Epemeridi giornaliere (geocentric, ecliptic of-date) per Sole→Plutone con astronomy-engine. Ritorna {name, longitude, sign, retro}; retrogrado determinato confrontando con -1 giorno. Usato da dashboard, lab e People per calcoli rapidi. Nessuna I/O DB.

src/lib/houses/runtime.ts

Helper runtime per le cuspidi delle case: converte Date UTC in JD e delega a computeHouses(system,{jd,latDeg,lonDeg}). Rileva fallbackApplied (es. Placidus oltre ±66.5° → Whole). Nessuna I/O DB.

src/lib/houses/placidus.ts (citata nella KB) & assignHouses

Implementa cuspidi Placidus e un assignHouses robusto (archi non uniformi), usato per assegnare una longitudine ad una casa; frammenti dell’algoritmo di ordering/settore sono in KB. Nessuna I/O DB (persistenza demandata alle API).

src/lib/houses/whole.ts

Calcolo cuspidi Whole Sign a partire dall’ASC (C1 = inizio segno dell’ASC, poi ogni 30°). Nessuna I/O DB.

src/lib/astro.ts (riassunto funzionale)

Motore astrologico: posizioni planetarie (astronomy-engine), ASC/MC, computeHouses(system) (instrada a Placidus o Whole), assegnazione case generica delegata al wrapper Placidus-safe, aspetti natali. È invocato dagli endpoint di compute e transits. Scritture DB avvengono nelle API, non qui.

src/lib/transits.ts (overview)

Calcolo transiti giorno/mese, aspetti e ranking con punteggio per selezione top eventi; usato da /api/transits/* e dal composer. Nessuna scrittura.

src/lib/composer.ts

“Composer” dei testi:

carica i natal points da chart_points,

carica righe da interpretations,

compone uno scheletro (dati, chiavi testo), opzionalmente invoca OpenAI (bypass se AI_BYPASS=true),

funzioni per natal e transiti.
Usa supabaseAdmin (service role) → solo letture nelle funzioni mostrate; la persistenza delle interpretazioni non è qui.

src/ai/systemPrompts.ts

Prompt system per la chat “chart-aware”: struttura d’output, note di sicurezza, tecnicismi opzionali (SHOW_TECH). Consumata da /api/chat.

7) Schema Database (Supabase)

Estratto tabelle principali (vedi db-schema.json completo nella KB/backups):

birth_data: input nascita (user_id FK→auth.users, date/time/tz/place/lat/lon). Sorgente per compute case/ASC/MC.

chart_points: posizioni natali calcolate (kind/name/longitude/sign/house/retro). Aggiornate dopo ricalcolo case.

house_cusps: 12 righe per sistema (whole|placidus), cusp 1..12 con longitude. Persistite da compute.

natal_aspects: aspetti natali (p1, p2, aspect, orb, strength).

user_prefs: preferenze correnti (house_system, current_*). Upsert via /api/user/prefs.

chat_sessions / chat_messages: storico conversazioni AI (sessione→messaggi).

people / people_chart_points / people_natal_aspects: analoghi per sinastria; compilati via PeoplePanel e /api/people.

transit_events: facoltativa per archiviare eventi-transito con punteggio/orb; non tutti i flussi la utilizzano.

8) Flussi dati tipici

Onboarding → Compute

L’utente salva birth_data e preferenze (user_prefs).

L’endpoint /api/chart/compute calcola cuspidi (computeHouses), aggiorna house_cusps, ricalcola chart_points (incluse case), calcola/aggiorna natal_aspects.

Dashboard Natal

Legge house_system (user_prefs), cusps (house_cusps) o calcola runtime se mancanti, legge chart_points. Render con ChartWheel/ChartWheelPro.

Transiti Giorno/Mese

/api/transits o /api/transits/month calcolano i transiti con astronomy-engine + ranking; UI li mappa alle case natali con assignHouses. Nessuna persistenza salvo eventuale export ICS.

Chat AI “chart-aware”

/api/chat costruisce il contesto da DB (natal/case/transiti), applica il systemPrompt, invia a OpenAI, salva cronologia in chat_sessions/chat_messages.

Sinastria (People)

PeoplePanel//api/people creano people, risolvono luogo, calcolano pianeti natalizi per la persona e inseriscono in people_chart_points (+ aspetti in people_natal_aspects se previsti), poi UI di sinastria li visualizza.

9) Dettagli algoritmici di supporto

Epemeridi: computeDailyPlanets(dateUTC) calcola lon/segno/retro (confronto −1 giorno) per Sole→Plutone (geocentric ecliptic of-date).

Case (runtime): computeHousesForDateUTC({system,dateUTC,latDeg,lonDeg}) → JD + computeHouses; se Placidus a latitudine estrema, segna fallbackApplied (Whole).

Assegnazione case (Placidus-safe): logica di ordering degli archi e test appartenenza settore [start,end) per assegnare house a una longitudine.

10) Script e strumenti

scripts/export-kb.mjs: esporta la KB (kb/_INDEX.md, kb/0001.md, …) escludendo asset binari e chunkando per dimensione.

scripts/gen-db-md.mjs: genera documentazione DB (colonne/PK/FK/commenti) da una connessione DATABASE_URL.

11) Prompt di sistema per la Chat

src/ai/systemPrompts.ts definisce lo stile, la struttura di output, la policy (benessere/entertainment, no claim medici/legali/finanziari) e la sezione facoltativa “Tech notes”. È il riferimento per una chat “chart-aware” che usa esclusivamente i dati passati nel contesto.

12) Nota operativa su /lab

La cartella /lab è un playground sicuro per iterare su componenti “Pro” (es. TransitsWheelPro, ChartWheelPro) e relativa UX (hovering, evidenziazione aspetti/pianeti, stili) senza impattare i file stabili in produzione. Qui si leggono dati reali dell’utente (quando loggato) o si simulano (fallback).

13) Come il chatbot usa il contesto utente

Input: chart_points (natal), house_cusps + user_prefs.house_system (case/assi), transiti (calcolati o passati dalla UI), preferenze utente (focus dominio, lingua, ecc.).

Processo: /api/chat costruisce stringhe CONTEXT_* e applica systemPrompt.

Output: messaggi salvati in chat_sessions/chat_messages.

Allegati utili

Schema completo DB: vedi db-schema.json/backups/db-schema.json (tutte le tabelle, colonne, PK/FK).

Overview funzionali con esempi di flusso: backups/PROJECT_OVERVIEW_23_9.md e backups/PROJECT_OVERVIEW_24_9.md.

14) TL;DR (ruoli chiave)

/app/*: pagine e API Routes; orchestrano calcolo/persistenza e montano i componenti UI.

/components/*: rendering grafico (ruote, pannelli, form); non scrivono su DB.

/lib/*: motori di calcolo (epemeridi, case, transiti) e compositori testo; stateless (persistence nelle API).

DB Supabase: birth_data → chart_points/natal_aspects/house_cusps; chat in chat_*; sinastrie in people_*.


## File: backups\PROJECT_OVERVIEW_23_9.md

Natal Transit AI — Mappa dei file & flussi

Questo documento descrive a cosa serve ogni file, dove viene usato, come interagisce col DB Supabase e quali altri moduli richiama, basandosi sulla codebase allegata e sullo schema del database. I riferimenti tra [quadre] indicano i file/estratti da cui è tratto ogni dettaglio.

1) Architettura ad alto livello

Frontend (Next.js App Router + React)

Pagine protette (Dashboard): Natal Chart, Transits, Daily Sky, Moon, Sinastry. Ogni pagina include ChatUI con contesto astrologico dell’utente.

Componenti grafici principali: ChartWheel (tema natale da DB), SkyWheel (cielo del giorno calcolato runtime), ChatUI (UI chat verso /api/chat).

Backend (API Routes)

Calcolo & scrittura: /api/chart/compute (case & assegnazione case), /api/people (crea persona + salva punti/aspetti).

Lettura/servizi: /api/transits/* (transiti), /api/calendar/ics (export eventi), /api/chat (costruisce contesto + memorizza chat).

Librerie interne (/lib)

astro.ts (motore astronomico: posizioni, ASC/MC, case Whole/Placidus, aspetti), transits.ts (transiti & ranking), houses/ (Placidus & Whole, runtime), synastry.ts (aspetti di sinastria), composer.ts (testi AI), openai.ts, time.ts, supabase* (client SSR/Browser/Admin).

Database (Supabase)

Tabelle chiave: birth_data, chart_points, natal_aspects, house_cusps, user_prefs, chat_sessions, chat_messages, people, people_chart_points, people_natal_aspects, transit_events, user_birth_data.

2) Frontend — Pagine e Componenti
2.1 Pagine Dashboard

src/app/dashboard/natal/page.tsx

Legge house system preferito da user_prefs. Carica 12 cuspidi da house_cusps per il sistema scelto; se mancano, ricalcola runtime da birth_data usando computeHouses. Carica i chart points da chart_points. Mostra ChartWheel e HouseSystemSwitcher; include ChatUI.

src/app/dashboard/compat/page.tsx

Flusso analogo: seleziona cuspidi (house_cusps), fa fallback runtime da birth_data, precarica natal points da chart_points per pannello sinastria; UI con HouseSystemSwitcher e PeoplePanel.

src/app/dashboard/people/[id]/page.tsx (lettura persona specifica)

Chiama /api/people/[id] per dettagli persona + punti salvati in people_chart_points.

2.2 Componenti grafici

ChartWheel

Render del tema natale: riceve points (da chart_points) e opzionalmente houseCusps (da house_cusps). È montato dinamicamente in pagine natal/compat ed usa librerie React/SVG per il disegno. (Props e caricamento mostrati in natal/page.tsx.)

SkyWheel

Cielo del giorno: disegna posizioni runtime (non persistite) — es. per /daily. Le posizioni sono calcolate con funzioni runtime (computePlanetsAtUTC/computeDailyPlanets) in lib/planets/runtime.ts.

ChatUI

Interfaccia chat collegata a /api/chat (invio messaggi, ricezione risposta). È caricata dinamicamente nelle pagine; /api/chat costruisce contesto (natal points, transiti, cuspidi) e salva i messaggi su chat_messages.

HouseSystemSwitcher

Permette di switchare Whole/Placidus: invoca /api/chart/compute?system=… per ricalcolare e persistire cuspidi + aggiornare chart_points.house.

3) Backend — API Routes
3.1 Tema natale & case

src/app/api/chart/compute/route.ts

Autenticazione via Supabase SSR client.

Legge/aggiorna preferenza house system in user_prefs (override da querystring).

Legge birth_data (date/time/tz/lat/lon). Se manca time, blocca il calcolo case.

Calcola JD (UT) da data/ora locale + tz_offset_minutes.

Chiama computeHouses(system, { jd, latDeg, lonDeg }), che instrada a Placidus o Whole.

Persistenza:

Sostituisce 12 righe in house_cusps per il sistema scelto.

Aggiorna chart_points.house per ogni punto natale usando assignHouses (Placidus‐safe).

Ritorna {systemUsed, asc, mc, fallbackApplied} (flag di fallback per latitudini estreme).

src/app/api/people/route.ts & [id]/route.ts

GET: lista persone (people) o singola persona + people_chart_points.

POST: crea persona in people, calcola punti/aspetti via lib/astro, e inserisce in people_chart_points e people_natal_aspects.

3.2 Chat & interpretazioni

src/app/api/chat/route.ts

Costruisce system/context: preferenze house (da house_cusps + user_prefs), natal context (da chart_points), transits del giorno, UI context; invia al modello OpenAI; salva cronologia in chat_messages (legata a chat_sessions).

src/app/api/interpret/transits/route.ts

Esegue pipeline interpretativa in due step: composeTransitsSkeleton (recupero dati/struttura) + refineTransitText (rifinitura AI, focus/lang). Non scrive su DB; ritorna testo + scheletro.

3.3 Transiti, calendario, ping

src/app/api/transits/month/route.ts

Endpoint per transiti del mese basato su astronomy-engine. (Tipi Point/Transit nel file.)

src/app/api/calendar/ics/route.ts

Genera file .ics on-the-fly per un transito (nessuna persistenza).

src/app/api/ping/route.ts

Healthcheck JSON ({ok:true,msg:'pong'}).

4) Librerie interne
4.1 Motore astrologico & case

src/lib/astro.ts

Calcola posizioni (geocentriche, eclittiche of-date) per Sole-Luna-pianeti usando astronomy-engine; rileva retrogradazioni; deduce segno/casa (Whole) e genera ASC/MC.

Casa system factory: computeHouses(system, { jd, latDeg, lonDeg }) → Placidus: computePlacidusCusps; Whole: computeWholeCuspsFromAsc(ASC, MC). Ritorna anche fallbackApplied.

assignHousesGeneric(longitude, cusps) delega al wrap-safe di Placidus (assignHouses) per gestire correttamente archi non uniformi.

src/lib/houses/placidus.ts (citato)

Espone computePlacidusCusps (12 cuspidi + ASC/MC da JD/lat/lon) e assignHouses (determinazione robusta della casa su archi Placidus irregolari). Usato da astro.ts e dalle API (/api/chart/compute). (Richiamato nei file di cui sopra.)

src/lib/houses/whole.ts

computeWholeCuspsFromAsc(ascDeg, mcDeg): cuspide I = inizio segno dell’ASC, poi ogni 30°. Ritorna {system:'whole', cusps, asc, mc}.

src/lib/houses/runtime.ts

Utilità runtime: da dateUTC → JD; chiama computeHouses; marca fallbackApplied per latitudini estreme. Non persiste su DB.

4.2 Transiti, sinastria, composer

src/lib/transits.ts

Calcolo longitudini transiting per pianeti esterni+personali; event matching su aspetti (con orb e score), ranking e helpers (noon UT, ecc.). Ritorna strutture TransitLongitude/TransitEventCalc.

src/lib/synastry.ts

Confronta due liste di punti natali; definisce orb per classi di punti (lum/pers/soc/out/ang), pesi per aspetto/punto; produce top-aspetti con score ordinato. Offre formatSynastryContext per il prompt del chatbot.

src/lib/composer.ts

Pipeline interpretativa AI:

Legge natal points (chart_points) e interpretations dal DB.

Calcola transits del giorno (computeTransitingLongitudes, computeTransitEventsForDay) e compone uno scheletro.

Se AI_BYPASS off e OPENAI_API_KEY presente, chiama chatComplete (modello configurabile).

4.3 Tempo, OpenAI, Supabase

src/lib/time.ts — timezone di default, todayISOInTZ, nowInfo (ISO, human, offset).

src/lib/openai.ts — wrapper chatComplete(messages, useRefiner?) con scelta modello da env (OPENAI_MODEL_*).

Supabase clients

supabaseServer.ts: SSR client con cookies (RSC: read-only; Route: mutate cookie). Legge NEXT_PUBLIC_SUPABASE_URL/ANON o fallback.

supabaseBrowser.ts: client browser con sessione persistente.

supabaseAdmin.ts: service role per job server-side (no refresh/persist).

supabase.ts: client base da env pubbliche.

4.4 Pianeti runtime (Daily)

src/lib/planets/runtime.ts

Con astronomy-engine calcola longitudini e retro per i pianeti in due istanti (oggi e ieri) e deduce il moto; mapping dei nomi, normalizzazione e segno. Usato per SkyWheel / daily.

5) Database — Schema e relazioni

Estratto da db-schema.json. Tipi e chiavi esterne sono riassunte per la comprensione del flusso.

birth_data — input di nascita utente: date, time?, tz_offset_minutes?, place_name?, lat?, lon?. FK su auth.users. Fonte primaria per JD/lat/lon nei calcoli case.

chart_points — posizioni natali (per user): kind, name, longitude, sign, house?, retro?. Aggiornamento house dopo calcolo cuspidi.

natal_aspects — aspetti tra punti natali (p1,p2,aspect,orb,strength/score).

house_cusps — 12 righe per utente e system (whole|placidus): cusp 1..12, longitude. Ricalcolate da /api/chart/compute.

user_prefs — preferenze (location corrente, TZ corrente, house_system default 'whole'). PK user_id.

chat_sessions & chat_messages — cronologia chat; chat_messages.session_id → FK su chat_sessions.id.

people — anagrafiche per sinastria (label, birth_date/time, tz, place, lat/lon). FK su auth.users.

people_chart_points / people_natal_aspects — analoghi a chart_points/natal_aspects ma per la tabella people.

transit_events — (struttura per archiviare calcoli di transito: date, t_planet, n_point, aspect, orb, score).

user_birth_data — versione normalizzata con birth_datetime_utc, latitude/longitude (supporto/ottimizzazioni).

6) Flussi principali end-to-end

Onboarding → Calcolo tema natale

L’utente salva birth_data.

/api/chart/compute legge preferenza house system (user_prefs), calcola cuspidi con computeHouses, persistendo 12 righe in house_cusps e aggiorna chart_points.house.

Pagina Natal

Legge user_prefs.house_system, carica 12 house_cusps; se mancanti, fallback runtime da birth_data con computeHouses. Carica chart_points. Renderizza ChartWheel.

Chat su ogni pagina

/api/chat compone contesto: cuspidi attive (e sistema), natal points, transiti correnti, e UI context. Chiama OpenAI e salva i messaggi su chat_messages.

People/Sinastria

/api/people crea persona, calcola punti/aspetti (lib/astro) e inserisce in people_chart_points/people_natal_aspects; GET /api/people/[id] ritorna persona + punti.

Transiti & ICS

/api/transits/month produce dataset dei transiti (no persistenza).

/api/calendar/ics esporta un evento iCalendar per il giorno del transito.

7) Note di implementazione su Placidus (già in codice)

Factory case: computeHouses('placidus'|'whole', …) dirige verso Placidus (cuspidi irregolari + assignHouses robusto) o Whole (equispaziate). ASC/MC inclusi nel risultato; fallback automatico per latitudini estreme.

Persistenza: /api/chart/compute elimina+inserisce house_cusps (12 righe) per il sistema scelto e rideriva chart_points.house via assignHouses.

Preferenze: user_prefs.house_system (default 'whole') aggiornabile via query param dell’endpoint compute. Le pagine leggono sempre dallo stato preferito e fanno fallback runtime se mancano righe in house_cusps.

8) Altri file di progetto

package.json — script utili: export:kb per rigenerare la KB markdown, docs:schema per doc DB. Dipendenze: astronomy-engine, @supabase/*, luxon, openai, ecc.

scripts/export-kb.mjs — traversa la repo ed esporta in chunk .md (150 KB cad.).

eslint.config.mjs, postcss.config.cjs, tailwind — setup lint/stili.

api/ping — healthcheck.

9) Glossario rapido (entità di dominio)

Chart Point: una riga in chart_points (o people_chart_points), es. Sun, Moon, … con longitude, sign, house, retro.

House Cusps: 12 longitudini (cuspidi I..XII) per system = 'whole'|'placidus' salvate in house_cusps. Cusp I = ASC, Cusp X = MC.

Natal Aspects: aspetti tra coppie di punti natali con orb e strength/score.

Transit Events: match tra transiting planet e natal point con aspect, orb, score.

10) Come leggere/seguire il codice

Parti dal flusso /api/chart/compute per capire come house system guida i calcoli e la persistenza; poi apri lib/astro.ts per la factory di case e la logica ASC/MC; completa con lib/houses/*.

Guarda dashboard/natal per capire come le pagine riusano i dati persistiti e come fanno fallback runtime; poi ChatUI + /api/chat per il contesto unificato al chatbot.

Per sinastria, passa da /api/people (POST) → lib/astro (calcolo) → tabelle people_* → UI compat.


## File: backups\PROJECT_OVERVIEW_24_9.md

Natal Transit AI — Guida alla Codebase (per ChatGPT)

Questo documento mappa cosa fa ogni file, dove viene usato, come interagisce con il DB e quali dipendenze richiama. È pensato per essere allegato alla KB del progetto così che ChatGPT possa orientarsi rapidamente.

1) Stack & dipendenze

Next.js 14 (App Router), React 18, TypeScript, Tailwind — frontend.

Supabase (auth/DB/storage), OpenAI (chat), astronomy-engine (epemeridi), Luxon (tempi), SWR (dati). Vedi package.json per versioni e script (dev, build, export:kb, docs:schema).

2) Schema Database (Supabase)

Tabelle chiave (estratto):

birth_data: input nascita (data/ora/luogo/TZ) per utente. FK su auth.users. Fonte per JD/lat/lon.

chart_points: posizioni natali calcolate (name/kind/longitude/sign/house/retro). Aggiornate anche dopo il ricalcolo case.

natal_aspects: aspetti tra punti natali (orb/strength).

house_cusps: 12 cuspidi per system = whole|placidus; C1=ASC, C10=MC.

user_prefs: preferenze (location/TZ correnti + house_system, default whole).

chat_sessions / chat_messages: storico chat.

people, people_chart_points, people_natal_aspects: analoghi per sinastria.

transit_events: (struttura di archiviazione transiti giornalieri, opzionale).

Nota operativa: le pagine leggono sempre il sistema case preferito da user_prefs.house_system (override via query dell’endpoint compute). Se le cuspidi mancano, fanno fallback al calcolo runtime.

3) API Routes (backend Next.js)
Auth

src/app/api/auth/set-session/route.ts
Scrive i cookie di sessione server-side a partire da access_token/refresh_token ricevuti dal client Supabase. Usa createSupabaseServerRouteClient. Restituisce JSON.

src/app/api/auth/signout/route.ts
Esegue supabase.auth.signOut() e redirige/risponde JSON a seconda del contesto (presente in due varianti equivalenti nella KB).

src/app/auth/callback/route.ts
Gestisce il redirect post-signup (PKCE/OTP): exchangeCodeForSession e redirect a /onboarding#birth.

Calendario

src/app/api/calendar/ics/route.ts
Genera un file .ics (evento all-day) per un transito: GET?title&date&desc. Nessuna persistenza.

Chatbot

src/app/api/chat/route.ts
Costruisce il contesto chat unendo:

NATALE: da chart_points (name/sign/house/retro).

TRANSITI odierni: se non già passati via UI, chiama /api/transits interno e formatta CONTEXT_TRANSITS_TODAY.

CASE: legge user_prefs.house_system e, se esistono, carica 12 cuspidi da house_cusps includendo ASC/MC nel contesto.

Prompt “system” per lo stile di risposta.
Chiama OpenAI (gpt-4o-mini), salva i messaggi eventuali in chat_messages.

Case & Cuspidi (core)

src/app/api/chart/compute/route.ts
Flusso completo:

Determina system (whole|placidus) da user_prefs o override ?system=... (e aggiorna user_prefs).

Legge birth_data dell’utente (richiede time per le case).

Calcola JD/UTC (gestendo tz_offset_minutes).

Calcola le cuspidi con computeHouses(system, { jd, latDeg, lonDeg, tzMinutes }).

Persiste 12 righe in house_cusps (dopo delete by user+system).

Aggiorna chart_points.house con assignHouses(...) (Placidus-aware).

Ritorna { ok, systemUsed, asc, mc, fallbackApplied }.

Compat / Sinastria

src/app/api/compat/[id]/route.ts
End-to-end per compatibilità: utilità di parsing sicuro, funzioni di synastry, possibile integrazione transiti “del giorno”; produce contesto CONTEXT_SYNASTRY.

4) Librerie interne (/lib)
Motore astrologico & case

src/lib/astro.ts
Factory dei calcoli: posizioni geocentriche (astronomy-engine), retrogradazioni, segno; ASC/MC; case via computeHouses(system) con Placidus o Whole; assignHousesGeneric delega a placidus.assignHouses per archi irregolari. (Descrizione consolidata nella KB.)

src/lib/houses/placidus.ts
Espone computePlacidusCusps(...) e assignHouses(...). Usato da astro.ts e da /api/chart/compute.

src/lib/houses/whole.ts
computeWholeCuspsFromAsc(ascDeg, mcDeg) → cusp I all’inizio del segno dell’ASC, poi ogni 30°.

src/lib/houses/runtime.ts
Helper runtime (UTC→JD, fallback flag). Non persiste.

Transiti & Sinastria

src/lib/transits.ts
Calcola longitudini dei pianeti in transito, match con punti natali su aspetti (conjunction|sextile|square|trine|opposition), orb e score, ranking. Tipi TransitLongitude e TransitEventCalc.

src/lib/synastry.ts
Confronta due set di punti natali: orbi per classi di punti, pesi per aspetti/punti, restituisce top-aspetti con score e orb. Fornisce formatSynastryContext(...) per il prompt del chatbot.

Composer (testi AI)

src/lib/composer.ts
Natal: legge chart_points + interpretations (DB); compone bullets + micro-azioni; opzionale refine/translate via OpenAI.
Transits: calcola top eventi→bullets→micro-azioni; refine via few-shot.
Usa systemRefiner, few-shot fewShot_planet/fewShot_transit.

Prompt & utilità

src/ai/systemPrompts.ts
Prompt system per risposte chart-aware, refiner editoriale, few-shot per transiti/natale (struttura Title/Meaning/Focus/Actions/Note + Tech notes opzionali).

src/lib/geo.ts
Nominatim search (caching & rate-limit), tz-lookup per timezone, calcolo offset minuti in Luxon.

src/lib/time.ts
todayISOInTZ, nowInfo (ISO/human/UTC offset).

Supabase clients:
supabaseServer.ts (SSR/RSC), supabaseBrowser.ts (client), supabaseAdmin.ts (service role), supabase.ts (base). Panoramica in KB.

OpenAI wrapper:
src/lib/openai.ts con chatComplete(...) (modello via env).

Grafica “Pro” (ruote migliorate)

src/lib/graphics/tokens.ts — palette/weight (segni, aspetti, stroke/font).

src/lib/graphics/glyphs.ts — simboli Unicode & path fallback, colori wrapper, normalizzazione EN/IT dei segni.

src/lib/graphics/polar.ts — utilità polari pure: polarToXY, describeArc, resolveCollisions, leaderLine.

5) Pagine (App Router)

src/app/layout.tsx
Shell dell’app (header/footer/disclaimer). Nota trasparenza: default Whole Sign o “solar chart” senza case se manca birth time.

src/app/chat/page.tsx
Monta ChatUI (senza contesto pre-iniettato).

src/app/dashboard/daily/page.tsx
Server component protetta (redirect se non loggato).

Legge TZ/posizione correnti da user_prefs.

Calcola sky points runtime con computePoints (da lib/astro).

Costruisce CONTEXT_TRANSITS_TODAY per ChatUI.

Renderizza SkyWheel + ChatUI.

Onboarding/Auth
src/app/onboarding/... (raccolta birth data; non tutto incluso nei chunk) + AuthForm.tsx (signup/signin via Supabase + POST a /api/auth/set-session per cookie SSR; poi redirect a /onboarding#birth).

/lab (ambiente di test componenti Pro)
Esempio: pagina “Lab · Transits Pro” legge chart_points, calcola transiting al volo, mostra ruota TransitsWheelPro — isolato dal flusso “prod” per iterare sulla grafica senza toccare i componenti stabili.

6) Componenti UI

src/components/ChatUI.tsx
Client component minimal per chat: mantiene stato locale, invia /api/chat con eventuale initialContext, mostra scambi. (Contiene placeholder d’aiuto per prompt utente.)

SkyWheel / ChartWheel / Pro
Dai chunk risultano SVG con etichette segno/casa e punti (“Sun/Moon/…”, sign, H{n} quando presente). Le versioni Pro usano le utilità grafiche (tokens, glyphs, polar) per un layout più ricco (colori per segno, collision avoidance, leader lines). Gli snippet evidenziano la resa testuale segno+casa accanto al glifo del punto.

Nota: le pagine /lab servono apposta per far evolvere WheelChartPro/SkyWheelPro/TransitsWheelPro senza intaccare i componenti “storici” già funzionanti.

7) Flussi end-to-end (riassunto)

Onboarding → Salvataggio dati
Auth (Supabase) → raccolta birth_data (+ geocoding/TZ via geo.ts). Alla conferma, l’utente può lanciare il calcolo.

Compute case (Placidus/Whole)
/api/chart/compute?system=placidus|whole: calcola cuspidi da birth_data, scrive house_cusps e aggiorna chart_points.house. Imposta/aggiorna user_prefs.house_system.

Dashboard /daily
Carica sky points runtime + transiti del giorno; produce contesto per Chat. Renderizza SkyWheel + ChatUI.

Chat
/api/chat: unisce natal (chart_points), house system + cuspidi (house_cusps, user_prefs), e transiti (interni o da UI) in un unico prompt “system”, quindi chiama OpenAI. Salva messaggi in chat_messages.

Sinastria
/api/compat/[id]: compone contesto con top aspetti tra due profili (people_*) e opzionalmente transiti; restituisce risposte coerenti col contesto.

8) Script & documentazione

scripts/export-kb.mjs — esporta la repository in chunk Markdown (kb/_INDEX.md, kb/0001.md, …), con esclusioni e size-cap, per condividerla con ChatGPT.

scripts/gen-db-md.mjs — genera docs/db-schema.md con tabelle/PK/FK/commenti usando DATABASE_URL.

9) Come “leggere” il progetto (roadmap per dev/AI)

Parti da /api/chart/compute per capire il pivot “case system → cuspidi → update house” e la persistenza.

Apri lib/astro.ts e lib/houses/* per i dettagli di ASC/MC e dei due sistemi (Placidus/Whole).

Guarda dashboard/daily + lib/transits.ts per il ciclo dei transiti e il contesto chat.

Studia /api/chat + ai/systemPrompts.ts per capire come nascono le risposte del chatbot.

Per la grafica, vedi lib/graphics/* e le pagine /lab per i componenti Pro in sviluppo isolato.

10) Glossario rapido

Chart Point: riga in chart_points (o people_chart_points), es. Sun/Moon… con longitude, sign, house, retro.

House Cusps: 12 longitudini C1..C12 in house_cusps per system. C1=ASC, C10=MC.

Natal Aspects / Transit Events: aspetti tra punti natali / tra transiting planet e natal point (con orb e score).

Appendice: pagine e componenti citati ma non integralmente nei chunk

Alcuni file (es. src/lib/astro.ts, src/lib/houses/placidus.ts, SkyWheel/ChartWheel/WheelChartPro) sono ampiamente referenziati da API e pagine qui documentate: la loro funzione è attestata in PROJECT_OVERVIEW e nell’uso da parte di /api/chart/compute, dashboard/daily, /lab e dei moduli grafici Pro.


## File: backups\PROJECT_OVERVIEW.md

- Obiettivo del progetto

    Web app astrologica che calcola:

    Tema natale

    Transiti (oggi / mese)

    Sinastria

    Cielo del giorno

    Calendario lunare

    Ogni sezione è affiancata da un chatbot AI contestualizzato sui dati astrologici dell’utente e del momento.

- Struttura generale
    - Frontend (Next.js App Router + React)

    Layout: layout.tsx, globals.css → struttura base e stili globali.

    Onboarding: raccoglie dati nascita (BirthForm) e location (CurrentLocationForm), salva tutto nel DB via API dedicate.

    Dashboard: pagine protette che mostrano:

    Natal chart (ChartWheel)

    Transits (TransitsToday)

    Daily sky (SkyWheel)

    Moon phase (MoonPhaseCard)
    Ogni pagina include ChatUI con contesto preimpostato.

    - Componenti grafici

    ChartWheel: disegna il tema natale (punti da chart_points nel DB).

    SkyWheel: disegna il cielo del giorno (punti calcolati al volo).

    ChatUI: interfaccia di chat, comunica con /api/chat.

    - Backend (API Routes)
    Calcolo & scrittura dati

    /api/chart/compute: punto centrale → calcola punti natali e aspetti (lib/astro), salva in birth_data, chart_points, natal_aspects.

    /api/user/prefs: salva preferenze utente (location corrente, sistema di case).

    /api/chat: costruisce contesto (chart_points + transiti odierni), chiama OpenAI, salva messaggi in chat_messages.

    - Lettura / servizi

    /api/transits: calcola transiti attuali usando lib/transits.

    /api/geo/resolve + /api/geo/search: geocoding, timezone.

    /api/calendar/ics: esporta eventi .ics per un transito.

    /api/interpret/...: genera testi più lunghi usando lib/composer.

    - Librerie interne (/lib)

    astro.ts → motore astrologico base: calcolo posizioni, case Whole Sign, aspetti.

    transits.ts → calcolo transiti giornalieri, orb e ranking con punteggio.

    composer.ts → compone testi interpretativi usando dati DB + AI.

    geo.ts → geocoding con Nominatim e calcolo TZ.

    time.ts → utilità temporali.

    openai.ts → wrapper API OpenAI.

    supabase* → client SSR/Browser per DB.

- Database (Supabase / Postgres)
    Tabelle principali

    users – anagrafica utente.

    birth_data – input nascita (data, ora, luogo, TZ).

    chart_points – posizioni calcolate (segno, casa, retro, ecc.).

    natal_aspects – aspetti fra punti natali.

    house_cusps – cuspidi case per sistema (whole o placidus).

    user_prefs – preferenze correnti (location, TZ, house system).

    chat_sessions / chat_messages – storico chat.

    interpretations – testi interpretativi (seedata).

    people – dati per sinastrie.

- Flusso dati

    Onboarding → salva in birth_data → /api/chart/compute genera chart_points, natal_aspects, house_cusps.

    Natal page → legge da chart_points.

    Daily page → calcola punti runtime con computePoints + preferenze da user_prefs.

    Transits → calcolo runtime via /api/transits.

    Chat → arricchisce contesto leggendo chart_points (e transiti) e salva messaggi in chat_messages.

- Considerazioni su implementazione Placidus

    Già predisposto: user_prefs.house_system + tabella house_cusps.

    Da fare: estendere lib/astro per calcolare cuspidi Placidus e assegnare case ai punti.

    Persistenza: chart_points.house + house_cusps con system='placidus'.

    UI: un solo componente Wheel, switch Whole/Placidus via pulsante.


## File: eslint.config.mjs

```js
import { dirname } from "path";
import { fileURLToPath } from "url";
import { FlatCompat } from "@eslint/eslintrc";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const compat = new FlatCompat({
  baseDirectory: __dirname,
});

const eslintConfig = [
  ...compat.extends("next/core-web-vitals", "next/typescript"),
  {
    ignores: [
      "node_modules/**",
      ".next/**",
      "out/**",
      "build/**",
      "next-env.d.ts",
    ],
  },
];

export default eslintConfig;

```


## File: next-env.d.ts

```ts
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/building-your-application/configuring/typescript for more information.

```
