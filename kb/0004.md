# Repository Knowledge Base (chunk 0004)


## File: src\lib\composer.ts

```ts
// src/lib/composer.ts
import { supabaseAdmin } from '@/lib/supabaseAdmin';
import { chatComplete } from '@/lib/openai';
import {
  type PointName,
  type AspectType,
} from '@/lib/astro';
import {
  computeTransitingLongitudes,
  computeTransitEventsForDay,
  type TransitEventCalc,
} from '@/lib/transits';
import { systemRefiner, fewShot_planet, fewShot_transit } from '@/ai/systemPrompts';

type Focus = 'work' | 'relationships' | 'energy';
type Lang = 'en' | 'it' | 'es' | 'pt';

type NatalPoint = { name: PointName; longitude: number; house: number | null; sign: string };
type InterpretationRow = { id: number; type: string; key: string; title: string | null; summary: string | null; tips: string | null };

function ensureUserId(user_id?: string): string {
  const env = process.env.DEV_USER_ID;
  const uid = (user_id && user_id.length > 0) ? user_id : env;
  if (!uid) throw new Error('Missing user_id or DEV_USER_ID');
  return uid;
}

function aiBypassOn(): boolean {
  return String(process.env.AI_BYPASS).toLowerCase() === 'true' || !process.env.OPENAI_API_KEY;
}

// ———————————————— Helpers DB ————————————————

async function loadNatalPoints(user_id: string): Promise<NatalPoint[]> {
  const { data, error } = await supabaseAdmin
    .from('chart_points')
    .select('name, longitude, house, sign')
    .eq('user_id', user_id);
  if (error) throw new Error(`chart_points.select: ${error.message}`);
  return (data ?? []).map(r => ({
    name: r.name as PointName,
    longitude: r.longitude as number,
    house: r.house as number | null,
    sign: String(r.sign),
  }));
}

async function loadInterpretations(keys: string[], types: string[]): Promise<InterpretationRow[]> {
  const { data, error } = await supabaseAdmin
    .from('interpretations')
    .select('id, type, key, title, summary, tips')
    .in('type', types)
    .in('key', keys);
  if (error) throw new Error(`interpretations.select: ${error.message}`);
  return data ?? [];
}

// ———————————————— Composer Natal ————————————————

export async function composeNatalSkeleton(user_id?: string) {
  const uid = ensureUserId(user_id);
  const points = await loadNatalPoints(uid);

  const keys: string[] = [];
  for (const p of points) {
    if (p.name === 'ASC' || p.name === 'MC') continue;
    keys.push(`${p.name}_${p.sign}`, `${p.name}@${p.sign}`);
    if (p.house) keys.push(`${p.name}_${p.house}`, `${p.name}@${p.house}`);
  }

  const rows = await loadInterpretations(keys, ['planet_in_sign', 'planet_in_house']);

  const bullets: string[] = [];
  const actions: string[] = [];

  for (const p of points) {
    if (p.name === 'ASC' || p.name === 'MC') continue;
    const signCard = rows.find(r => r.key === `${p.name}_${p.sign}` || r.key === `${p.name}@${p.sign}`);
    const houseCard = p.house ? rows.find(r => r.key === `${p.name}_${p.house}` || r.key === `${p.name}@${p.house}`) : undefined;

    const title = `${p.name} in ${p.sign}${p.house ? ` (House ${p.house})` : ''}`;
    const sum = [signCard?.summary, houseCard?.summary].filter(Boolean).join(' ');
    bullets.push(`• ${title}: ${sum || 'natural strengths you can apply with patience and flexibility.'}`);

    const tipsMerge = [signCard?.tips, houseCard?.tips].filter(Boolean).join(' ');
    if (tipsMerge) {
      const split = tipsMerge.split(/[\n•\-]+/).map(s => s.trim()).filter(s => s.length > 0);
      actions.push(...split.slice(0, 2));
    }
  }

  if (actions.length === 0) {
    actions.push('Write 3 lines about what energizes you today.');
    actions.push('Tidy one small area for 5 minutes.');
  }

  return { bullets, actions: actions.slice(0, 6) };
}

function buildNatalEN(skeleton: { bullets: string[]; actions: string[] }, focus: Focus[]): string {
  const f = focus.length ? focus.join(', ') : 'general';
  return [
    `Here’s a gentle read of your natal chart themes (focus: ${f}).`,
    '',
    ...skeleton.bullets,
    '',
    'Try today:',
    ...skeleton.actions.map(a => `• ${a}`),
    '',
    'Disclaimer: For wellness/entertainment only. Not medical, legal, or financial advice.'
  ].join('\n');
}

export async function refineNatalText(skeleton: { bullets: string[]; actions: string[] }, focus: Focus[], lang: Lang = 'en') {
  if (aiBypassOn()) {
    // Bypass: ritorna EN semplice
    const textEN = buildNatalEN(skeleton, focus);
    return lang === 'en' ? textEN : textEN; // in bypass manteniamo EN
  }

  const userMsg = [
    `User focus: ${focus.join(', ') || 'general'}.`,
    'Skeleton:',
    ...skeleton.bullets,
    'Micro-actions:',
    ...skeleton.actions.map(a => `- ${a}`)
  ].join('\n');

  const contentEN = await chatComplete(
    [
      { role: 'system', content: systemRefiner },
      { role: 'user', content: fewShot_planet.user },
      { role: 'assistant', content: fewShot_planet.assistant },
      { role: 'user', content: userMsg },
    ],
    true
  );

  if (lang === 'en') return contentEN;

  const langLabel = lang === 'it' ? 'Italian' : lang === 'es' ? 'Spanish' : 'Portuguese';
  const translated = await chatComplete(
    [
      { role: 'system', content: 'Translate to the requested language preserving tone and bullet structure. Keep it concise.' },
      { role: 'user', content: `Language: ${langLabel}\n\n${contentEN}` }
    ],
    true
  );
  return translated;
}

// ———————————————— Composer Transits ————————————————

export async function composeTransitsSkeleton(user_id?: string, dateIso?: string, limit = 5) {
  const uid = ensureUserId(user_id);
  const date = dateIso ?? new Date().toISOString().slice(0, 10);

  const points = await loadNatalPoints(uid);
  const natalLite = points.map(p => ({ name: p.name, longitude: p.longitude }));

  const longs = computeTransitingLongitudes(date);
  const events = computeTransitEventsForDay(date, longs, natalLite);
  const top = events.slice(0, limit);

  const keys: string[] = [];
  for (const e of top) {
    keys.push(`${e.t_planet}_${e.aspect}_${e.n_point}`, `${e.t_planet}@${e.n_point}@${e.aspect}`);
  }
  const rows = await loadInterpretations(keys, ['transit_to_nat']);

  const bullets: string[] = [];
  const actions: string[] = [];

  for (const e of top) {
    const title = `${e.t_planet} ${labelAspect(e.aspect)} ${e.n_point} (orb ${e.orb}°)`;
    const card = rows.find(r =>
      r.key === `${e.t_planet}_${e.aspect}_${e.n_point}` ||
      r.key === `${e.t_planet}@${e.n_point}@${e.aspect}`
    );
    bullets.push(`• ${title}: ${card?.summary || 'energy pattern you can use with awareness.'}`);

    if (card?.tips) {
      const split = card.tips.split(/[\n•\-]+/).map(s => s.trim()).filter(s => s.length > 0);
      actions.push(...split.slice(0, 2));
    }
  }

  if (actions.length === 0) {
    actions.push('2 minutes of slow breathing (inhale 4, exhale 6).');
    actions.push('Write one line about your intention today.');
  }

  return { date, bullets, actions, top };
}

function buildTransitsEN(skeleton: { date: string; bullets: string[]; actions: string[] }, focus: Focus[]): string {
  const f = focus.length ? focus.join(', ') : 'general';
  return [
    `Transits for ${skeleton.date} (focus: ${f}).`,
    '',
    ...skeleton.bullets,
    '',
    'Try today:',
    ...skeleton.actions.map(a => `• ${a}`),
    '',
    'Disclaimer: For wellness/entertainment only. Not medical, legal, or financial advice.'
  ].join('\n');
}

export async function refineTransitText(
  skeleton: { date: string; bullets: string[]; actions: string[]; top: TransitEventCalc[] },
  focus: Focus[],
  lang: Lang = 'en'
) {
  if (aiBypassOn()) {
    const textEN = buildTransitsEN(skeleton, focus);
    return lang === 'en' ? textEN : textEN; // in bypass manteniamo EN
  }

  const userMsg = [
    `Date: ${skeleton.date}`,
    `User focus: ${focus.join(', ') || 'general'}.`,
    'Transit bullets:',
    ...skeleton.bullets,
    'Micro-actions:',
    ...skeleton.actions.map(a => `- ${a}`)
  ].join('\n');

  const contentEN = await chatComplete(
    [
      { role: 'system', content: systemRefiner },
      { role: 'user', content: fewShot_transit.user },
      { role: 'assistant', content: fewShot_transit.assistant },
      { role: 'user', content: userMsg },
    ],
    true
  );

  if (lang === 'en') return contentEN;

  const langLabel = lang === 'it' ? 'Italian' : lang === 'es' ? 'Spanish' : 'Portuguese';
  const translated = await chatComplete(
    [
      { role: 'system', content: 'Translate to the requested language preserving tone and bullet structure. Keep it concise.' },
      { role: 'user', content: `Language: ${langLabel}\n\n${contentEN}` }
    ],
    true
  );
  return translated;
}

// ———————————————— Utils ————————————————

function labelAspect(a: AspectType): string {
  switch (a) {
    case 'conjunction': return 'conjunct';
    case 'sextile':     return 'sextile to';
    case 'square':      return 'square to';
    case 'trine':       return 'trine to';
    case 'opposition':  return 'opposition to';
  }
}

```


## File: src\lib\geo.ts

```ts
// src/lib/geo.ts
import { DateTime } from 'luxon';
import tzLookup from 'tz-lookup';

export type GeoSearchItem = {
  place_id: string;
  display_name: string;
  name?: string;
  lat: number;
  lon: number;
  type?: string;
  class?: string;
  address?: {
    city?: string;
    town?: string;
    village?: string;
    state?: string;
    country?: string;
    country_code?: string;
  };
};

type CacheEntry<T> = { value: T; expires: number };

const ONE_HOUR = 60 * 60 * 1000;
const CACHE_TTL_MS = ONE_HOUR;
const RATE_LIMIT_MS = 1100;

declare global {
  // eslint-disable-next-line no-var
  var __geoCache: Map<string, CacheEntry<unknown>> | undefined;
  // eslint-disable-next-line no-var
  var __lastNominatimFetch: number | undefined;
}

if (!globalThis.__geoCache) globalThis.__geoCache = new Map<string, CacheEntry<unknown>>();
if (typeof globalThis.__lastNominatimFetch !== 'number') globalThis.__lastNominatimFetch = 0;

const cache = globalThis.__geoCache as Map<string, CacheEntry<unknown>>;

function setCache<T>(key: string, value: T, ttlMs = CACHE_TTL_MS): void {
  cache.set(key, { value, expires: Date.now() + ttlMs });
}

function getCache<T>(key: string): T | null {
  const hit = cache.get(key);
  if (!hit) return null;
  if (hit.expires <= Date.now()) {
    cache.delete(key);
    return null;
  }
  return hit.value as T;
}

async function respectRateLimit(): Promise<void> {
  const last = globalThis.__lastNominatimFetch ?? 0;
  const since = Date.now() - last;
  if (since < RATE_LIMIT_MS) {
    await new Promise((r) => setTimeout(r, RATE_LIMIT_MS - since));
  }
}

function toStringSafe(v: unknown): string {
  return typeof v === 'string' ? v : String(v ?? '');
}

function toNumberSafe(v: unknown): number {
  const n = Number(v);
  if (Number.isFinite(n)) return n;
  const s = toStringSafe(v);
  const pf = parseFloat(s);
  return Number.isFinite(pf) ? pf : NaN;
}

export async function nominatimSearch(q: string, limit = 5): Promise<GeoSearchItem[]> {
  const base = process.env.GEOCODING_BASE_URL || 'https://nominatim.openstreetmap.org';
  const email = process.env.GEOCODING_EMAIL;
  const key = `nominatim:${q}:${limit}`;

  const cached = getCache<GeoSearchItem[]>(key);
  if (cached) return cached;

  await respectRateLimit();

  const url = new URL(`${base}/search`);
  url.searchParams.set('format', 'jsonv2');
  url.searchParams.set('q', q);
  url.searchParams.set('addressdetails', '1');
  url.searchParams.set('limit', String(limit));
  if (email) url.searchParams.set('email', email);

  const res = await fetch(url.toString(), {
    headers: { 'User-Agent': `NatalTransitsChat/0.1 (${email || 'no-email-provided'})` },
  });
  globalThis.__lastNominatimFetch = Date.now();

  if (!res.ok) throw new Error(`Nominatim error ${res.status}`);

  const data: unknown = await res.json();
  if (!Array.isArray(data)) throw new Error('Unexpected Nominatim response (not an array)');

  const items: GeoSearchItem[] = data.map((r: unknown) => {
    const rr = (r ?? {}) as Record<string, unknown>;
    const addr = (rr.address ?? {}) as Record<string, unknown>;
    return {
      place_id: toStringSafe(rr.place_id),
      display_name: toStringSafe(rr.display_name),
      name: rr.name === undefined ? undefined : toStringSafe(rr.name),
      lat: toNumberSafe(rr.lat),
      lon: toNumberSafe(rr.lon),
      type: rr.type === undefined ? undefined : toStringSafe(rr.type),
      class: rr.class === undefined ? undefined : toStringSafe(rr.class),
      address: {
        city:
          addr.city !== undefined
            ? toStringSafe(addr.city)
            : addr.town !== undefined
            ? toStringSafe(addr.town)
            : addr.village !== undefined
            ? toStringSafe(addr.village)
            : undefined,
        state: addr.state === undefined ? undefined : toStringSafe(addr.state),
        country: addr.country === undefined ? undefined : toStringSafe(addr.country),
        country_code: addr.country_code === undefined ? undefined : toStringSafe(addr.country_code),
      },
    };
  });

  setCache(key, items);
  return items;
}

export function tzNameFromLatLon(lat: number, lon: number): string | null {
  try {
    const z = tzLookup(lat, lon);
    return typeof z === 'string' && z.length > 0 ? z : null;
  } catch {
    return null;
  }
}

/**
 * Offset in minuti da UTC per una data/ora locale.
 * @param isoDate YYYY-MM-DD
 * @param hhmm HH:MM (24h)
 * @param tzName es. "Europe/Rome"
 */
export function tzOffsetMinutes(isoDate: string, hhmm: string, tzName: string): number | null {
  if (!isoDate || !hhmm || !tzName) return null;
  const dt = DateTime.fromISO(`${isoDate}T${hhmm}`, { zone: tzName });
  return dt.isValid ? dt.offset : null;
}

```


## File: src\lib\openai.ts

```ts
// src/lib/openai.ts
type ChatRole = 'system' | 'user' | 'assistant';

export type ChatMessage = { role: ChatRole; content: string };

function getModel(envName: 'OPENAI_MODEL_CHAT' | 'OPENAI_MODEL_REFINER', fallback: string): string {
  const m = process.env[envName];
  return (m && m.trim().length > 0) ? m : fallback;
}

export async function chatComplete(messages: ChatMessage[], useRefiner = false): Promise<string> {
  const apiKey = process.env.OPENAI_API_KEY;
  if (!apiKey) {
    throw new Error('Missing OPENAI_API_KEY');
  }

  const model = useRefiner
    ? getModel('OPENAI_MODEL_REFINER', 'gpt-4o-mini')
    : getModel('OPENAI_MODEL_CHAT', 'gpt-4o-mini');

  const body = {
    model,
    messages,
    temperature: 0.8,
    top_p: 1,
  };

  const res = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${apiKey}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(body),
  });

  if (!res.ok) {
    const txt = await res.text().catch(() => '');
    throw new Error(`OpenAI error ${res.status}: ${txt}`);
  }
  const data: unknown = await res.json();
  // type guard minimale
  const msg = (data as { choices?: Array<{ message?: { content?: string } }> })?.choices?.[0]?.message?.content;
  if (typeof msg !== 'string' || msg.length === 0) {
    throw new Error('OpenAI returned empty message');
  }
  return msg.trim();
}

```


## File: src\lib\supabase.ts

```ts
import { createClient } from '@supabase/supabase-js'


const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!


export const supabase = createClient(supabaseUrl, supabaseAnonKey)
```


## File: src\lib\supabaseAdmin.ts

```ts
import { createClient } from '@supabase/supabase-js';


const url = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;


export const supabaseAdmin = createClient(url, serviceKey, {
auth: { autoRefreshToken: false, persistSession: false }
});
```


## File: src\lib\supabaseBrowser.ts

```ts
// src/lib/supabaseBrowser.ts
import { createClient } from '@supabase/supabase-js';

export function createSupabaseBrowser() {
  const url = process.env.NEXT_PUBLIC_SUPABASE_URL!;
  const anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;
  return createClient(url, anon, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
    },
  });
}

```


## File: src\lib\supabaseServer.ts

```ts
// src/lib/supabaseServer.ts
import { cookies } from 'next/headers';
import { createServerClient, type CookieOptions } from '@supabase/ssr';

function getSupabaseUrlAndKey() {
  const url =
    process.env.NEXT_PUBLIC_SUPABASE_URL ||
    process.env.SUPABASE_URL ||
    '';
  const anon =
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY ||
    process.env.SUPABASE_ANON_KEY ||
    '';
  if (!url || !anon) {
    throw new Error(
      "Your project's URL and Key are required to create a Supabase client!\n" +
      'Set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY in .env.local'
    );
  }
  return { url, anon };
}

/** Da usare in Server Components (RSC): NESSUNA mutazione cookie */
export function createSupabaseServerComponentClient() {
  const cookieStore = cookies();
  const { url, anon } = getSupabaseUrlAndKey();

  return createServerClient(url, anon, {
    cookies: {
      get(name: string) {
        return cookieStore.get(name)?.value;
      },
      // set/remove NON disponibili in RSC: no-op per evitare errori
      set() {},
      remove() {},
    },
  });
}

/** Da usare SOLO in Route Handlers / Server Actions: può mutare cookie */
export function createSupabaseServerRouteClient() {
  const cookieStore = cookies();
  const { url, anon } = getSupabaseUrlAndKey();

  return createServerClient(url, anon, {
    cookies: {
      get(name: string) {
        return cookieStore.get(name)?.value;
      },
      set(name: string, value: string, options: CookieOptions) {
        cookieStore.set({ name, value, ...options });
      },
      remove(name: string, options: CookieOptions) {
        cookieStore.set({ name, value: '', ...options });
      },
    },
  });
}

```


## File: src\lib\time.ts

```ts
// src/lib/time.ts
import { DateTime } from 'luxon';

export function getDefaultTZ(): string {
  return process.env.DEFAULT_TZ || 'UTC';
}

export function todayISOInTZ(tz?: string): string {
  const zone = tz || getDefaultTZ();
  return DateTime.now().setZone(zone).toFormat('yyyy-LL-dd'); // YYYY-MM-DD
}

export function nowInfo(tz?: string) {
  const zone = tz || getDefaultTZ();
  const dt = DateTime.now().setZone(zone);
  return {
    tz: zone,
    now_iso: dt.toISO(),
    now_human: dt.toFormat('cccc, dd LLL yyyy HH:mm'),
    utc_offset_minutes: dt.offset, // es. +120 per CEST
  };
}

```


## File: src\lib\transits.ts

```ts
// src/lib/transits.ts
import * as Astronomy from 'astronomy-engine';
import {
  type BodyName,
  type PointName,
  type AspectType,
  normalizeDeg,
} from '@/lib/astro';

export type TransitLongitude = {
  name: BodyName;
  longitude: number; // 0..360
};

export type NatalPointLite = {
  name: PointName;
  longitude: number;
};

export type TransitEventCalc = {
  date: string;         // YYYY-MM-DD (UTC day)
  t_planet: BodyName;   // transiting planet
  n_point: PointName;   // natal planet/angle
  aspect: AspectType;   // conj/sxt/sqr/trn/opp
  orb: number;          // degrees (0..maxOrb)
  score: number;        // 0..1
};

const TRANSIT_PLANETS: BodyName[] = [
  'Sun', 'Moon', 'Mercury', 'Venus', 'Mars',
  'Jupiter', 'Saturn', 'Uranus', 'Neptune', 'Pluto',
];

const BODY_ENUM: Record<BodyName, Astronomy.Body> = {
  Sun: Astronomy.Body.Sun,
  Moon: Astronomy.Body.Moon,
  Mercury: Astronomy.Body.Mercury,
  Venus: Astronomy.Body.Venus,
  Mars: Astronomy.Body.Mars,
  Jupiter: Astronomy.Body.Jupiter,
  Saturn: Astronomy.Body.Saturn,
  Uranus: Astronomy.Body.Uranus,
  Neptune: Astronomy.Body.Neptune,
  Pluto: Astronomy.Body.Pluto,
};

function rad(d: number): number { return (d * Math.PI) / 180; }
function deg(r: number): number { return (r * 180) / Math.PI; }

const OBLIQUITY = (23.4392911 * Math.PI) / 180;

function eclipticFromEquatorial(eq: Astronomy.EquatorialCoordinates): { elon: number } {
  // RA in ore → gradi
  const raDeg = eq.ra * 15;
  const decDeg = eq.dec;
  const ra = rad(raDeg);
  const dec = rad(decDeg);
  const sinE = Math.sin(OBLIQUITY);
  const cosE = Math.cos(OBLIQUITY);
  const sinRa = Math.sin(ra);
  const cosRa = Math.cos(ra);
  const y = sinRa * cosE + Math.tan(dec) * sinE;
  const x = cosRa;
  const elon = Math.atan2(y, x);
  return { elon: normalizeDeg(deg(elon)) };
}

function geocentricEclLongitude(body: Astronomy.Body, when: Date): number {
  const vec = Astronomy.GeoVector(body, when, true);
  const eq  = Astronomy.EquatorFromVector(vec);
  return eclipticFromEquatorial(eq).elon;
}

export function utNoon(dateIso: string): Date {
  const [y, m, d] = dateIso.split('-').map((s) => Number(s));
  return new Date(Date.UTC(y, (m - 1), d, 12, 0, 0)); // 12:00 UTC
}

export function computeTransitingLongitudes(dateIso: string): TransitLongitude[] {
  const when = utNoon(dateIso);
  return TRANSIT_PLANETS.map((p) => ({
    name: p,
    longitude: geocentricEclLongitude(BODY_ENUM[p], when),
  }));
}

const ASPECT_DEGREES: Record<AspectType, number> = {
  conjunction: 0,
  sextile: 60,
  square: 90,
  trine: 120,
  opposition: 180,
};

function minAngle(a: number, b: number): number {
  let d = Math.abs(normalizeDeg(a - b));
  if (d > 180) d = 360 - d;
  return d;
}

function classOfPoint(name: PointName): 'lum' | 'pers' | 'soc' | 'out' | 'ang' {
  if (name === 'Sun' || name === 'Moon') return 'lum';
  if (name === 'Mercury' || name === 'Venus' || name === 'Mars') return 'pers';
  if (name === 'Jupiter' || name === 'Saturn') return 'soc';
  if (name === 'Uranus' || name === 'Neptune' || name === 'Pluto') return 'out';
  return 'ang';
}

// MVP guideline orbs: 6° luminari, 5° personali/angoli, 3° lenti
export function maxOrbForPair(transiting: BodyName, natal: PointName): number {
  const cT = classOfPoint(transiting);
  const cN = classOfPoint(natal);
  if (cT === 'lum' || cN === 'lum') return 6;
  if (cT === 'pers' || cN === 'pers' || cN === 'ang') return 5;
  return 3;
}

function aspectWeight(a: AspectType): number {
  switch (a) {
    case 'conjunction': return 1.00;
    case 'opposition':  return 0.95;
    case 'trine':       return 0.90;
    case 'square':      return 0.85;
    case 'sextile':     return 0.75;
  }
}

function transitPlanetWeight(p: BodyName): number {
  switch (classOfPoint(p)) {
    case 'lum': return 0.85;  // per non far dominare la Luna
    case 'pers': return 0.90;
    case 'soc': return 0.95;
    case 'out': return 1.00;  // lenti più “pesanti”
    case 'ang': return 0.95;
  }
}

function natalPointWeight(p: PointName): number {
  switch (classOfPoint(p)) {
    case 'lum': return 1.00;
    case 'ang': return 0.95;
    case 'pers': return 0.90;
    case 'soc': return 0.80;
    case 'out': return 0.70;
  }
}

export function computeTransitEventsForDay(
  dateIso: string,
  transits: TransitLongitude[],
  natalPoints: NatalPointLite[]
): TransitEventCalc[] {
  const events: TransitEventCalc[] = [];
  const aspects: AspectType[] = ['conjunction', 'sextile', 'square', 'trine', 'opposition'];

  for (const t of transits) {
    for (const n of natalPoints) {
      const d = minAngle(t.longitude, n.longitude);
      // aspetto più vicino
      let best: { a: AspectType; diff: number } | null = null;
      for (const a of aspects) {
        const ad = ASPECT_DEGREES[a];
        const diff = Math.abs(d - ad);
        if (best === null || diff < best.diff) best = { a, diff };
      }
      if (!best) continue;

      const maxOrb = maxOrbForPair(t.name, n.name);
      if (best.diff <= maxOrb) {
        const score =
          aspectWeight(best.a) *
          transitPlanetWeight(t.name) *
          natalPointWeight(n.name);

        events.push({
          date: dateIso,
          t_planet: t.name,
          n_point: n.name,
          aspect: best.a,
          orb: Number(best.diff.toFixed(2)),
          score: Number(score.toFixed(3)),
        });
      }
    }
  }

  // ordina per score desc, poi orb asc
  events.sort((A, B) => (B.score - A.score) || (A.orb - B.orb));
  return events;
}

```


## File: src\types\tz-lookup.d.ts

```ts
﻿declare module 'tz-lookup' {
  export default function tzLookup(lat: number, lon: number): string;
}

```


## File: supabase\migrations\0001_init.sql

```sql
-- Enable useful extensions
id bigserial primary key,
session_id uuid not null references public.chat_sessions(id) on delete cascade,
role text not null check (role in ('user','assistant','system')),
content text not null,
created_at timestamptz not null default now()
);
create index if not exists idx_chat_messages_session on public.chat_messages(session_id);


-- RLS
alter table public.users enable row level security;
alter table public.birth_data enable row level security;
alter table public.chart_points enable row level security;
alter table public.natal_aspects enable row level security;
alter table public.transit_events enable row level security;
alter table public.interpretations enable row level security;
alter table public.chat_sessions enable row level security;
alter table public.chat_messages enable row level security;


-- policies: users (owner read/update)
create policy users_select_own on public.users
for select using (id = auth.uid());
create policy users_update_own on public.users
for update using (id = auth.uid()) with check (id = auth.uid());
-- no insert/delete by clients


-- policies: tables with user_id (owner-only full access)
create policy bd_rw_own on public.birth_data
for all using (user_id = auth.uid()) with check (user_id = auth.uid());


create policy cp_rw_own on public.chart_points
for all using (user_id = auth.uid()) with check (user_id = auth.uid());


create policy na_rw_own on public.natal_aspects
for all using (user_id = auth.uid()) with check (user_id = auth.uid());


create policy te_rw_own on public.transit_events
for all using (user_id = auth.uid()) with check (user_id = auth.uid());


create policy cs_rw_own on public.chat_sessions
for all using (user_id = auth.uid()) with check (user_id = auth.uid());


create policy cm_read_by_session on public.chat_messages
for select using (exists (
select 1 from public.chat_sessions s
where s.id = chat_messages.session_id and s.user_id = auth.uid()
));
create policy cm_write_by_session on public.chat_messages
for insert with check (exists (
select 1 from public.chat_sessions s
where s.id = chat_messages.session_id and s.user_id = auth.uid()
));


-- interpretations: readable by anyone, writable only with service role
create policy interp_public_read on public.interpretations
for select using (true);
-- (no insert/update/delete policy for anon/auth; use service role key in server routes)
```


## File: supabase\migrations\2025-09-17_add_user_prefs.sql

```sql
-- 2025-09-17_add_user_prefs.sql
create table if not exists public.user_prefs (
  user_id uuid primary key references public.users(id) on delete cascade,
  current_place_name text,
  current_lat double precision,
  current_lon double precision,
  current_tz_name text,
  focus jsonb default '[]'::jsonb, -- es. ["work","relationships"]
  updated_at timestamptz default now()
);

alter table public.user_prefs enable row level security;

do $$
begin
  if not exists (
    select 1 from pg_policies where schemaname='public' and tablename='user_prefs' and policyname='user_prefs_select_own'
  ) then
    create policy user_prefs_select_own
      on public.user_prefs for select
      using (auth.uid() = user_id);
  end if;

  if not exists (
    select 1 from pg_policies where schemaname='public' and tablename='user_prefs' and policyname='user_prefs_upsert_own'
  ) then
    create policy user_prefs_upsert_own
      on public.user_prefs for insert with check (auth.uid() = user_id);
    create policy user_prefs_update_own
      on public.user_prefs for update using (auth.uid() = user_id);
  end if;
end$$;

```


## File: supabase\seed\interpretations_seed.sql

```sql
-- Minimal seed: 48 schede (12 Sun in sign, 12 Moon in house, 12 Mercury in house, 12 transits examples)


-- SUN in SIGNS (12)
insert into public.interpretations (type, key, title, summary, tips) values
('planet_in_sign','sun_in_aries','Sun in Aries','Vitality aims at initiative and direct action. You thrive when you start things and move first.','["Begin a small challenge today","Act before overthinking","Channel energy into exercise"]'),
('planet_in_sign','sun_in_taurus','Sun in Taurus','Steady growth, comfort and tangible results. You build slowly but surely.','["Commit to one practical step","Declutter one small area","Cook a grounding meal"]'),
('planet_in_sign','sun_in_gemini','Sun in Gemini','Curiosity, variety and communication fuel you. Learning keeps you alive.','["Write a short note or post","Call someone and share ideas","Test a new tool for 10 minutes"]'),
('planet_in_sign','sun_in_cancer','Sun in Cancer','Care, memory and emotional safety guide your drive. Home base matters.','["Tend to a personal space","Cook or share comfort food","Reach out to a trusted friend"]'),
('planet_in_sign','sun_in_leo','Sun in Leo','Creative expression and heart‑led courage. Being seen lights you up.','["Showcase a small work","Offer genuine praise","Add play to one task"]'),
('planet_in_sign','sun_in_virgo','Sun in Virgo','Refinement, service and useful details. You improve systems.','["Tidy a workflow (10 min)","Ship a small fix","List top 3 priorities"]'),
('planet_in_sign','sun_in_libra','Sun in Libra','Balance, aesthetics and fair exchange. You shine with partners.','["Invite feedback kindly","Beautify a corner","Broker a win‑win"]'),
('planet_in_sign','sun_in_scorpio','Sun in Scorpio','Depth, focus and transformation. You renew by going beneath the surface.','["Protect quiet focus time","Release one draining habit","Journal a fear → next step"]'),
('planet_in_sign','sun_in_sagittarius','Sun in Sagittarius','Meaning, exploration and optimism. Aim the arrow beyond the usual.','["Read 5 pages on a big idea","Take a longer walk","Plan a micro‑adventure"]'),
('planet_in_sign','sun_in_capricorn','Sun in Capricorn','Structure, mastery and long‑term goals. You build what lasts.','["Define one metric","Block 25 minutes deep work","Say no to a distraction"]'),
('planet_in_sign','sun_in_aquarius','Sun in Aquarius','Originality, networks and future thinking. You thrive on systems and people.','["Share a helpful resource","Automate a tiny task","DM someone you admire"]'),
('planet_in_sign','sun_in_pisces','Sun in Pisces','Imagination, empathy and flow. You sense connections others miss.','["5 minutes of breathwork","Add music to a task","Sketch a dream idea"]');


-- MOON in HOUSES (12)
insert into public.interpretations (type, key, title, summary, tips) values
('planet_in_house','moon_house_1','Moon in House I','Feelings show on the surface; moods start the day.','["Name your mood","Keep morning simple","Hydrate early"]'),
('planet_in_house','moon_house_2','Moon in House II','Emotional security links to resources and values.','["Check one expense","Cook at home","List 3 non‑negotiables"]'),
('planet_in_house','moon_house_3','Moon in House III','Daily exchanges shape mood; siblings/neighbors matter.','["Send a kind message","Walk your block","Read 10 minutes"]'),
('planet_in_house','moon_house_4','Moon in House IV','Home and roots restore you.','["Tidy a room corner","Ask about family story","Rest earlier"]'),
('planet_in_house','moon_house_5','Moon in House V','Play, romance and creativity feed the heart.','["Do a 10‑min hobby","Write a compliment","Dance to one song"]'),
('planet_in_house','moon_house_6','Moon in House VI','Routines and service stabilize emotions.','["Prep a simple meal","Stretch 5 minutes","Finish a small chore"]'),
('planet_in_house','moon_house_7','Moon in House VII','Partners and mirroring moods teach balance.','["Listen without fixing","Plan a shared micro‑ritual","Express one need"]'),
('planet_in_house','moon_house_8','Moon in House VIII','Shared resources and deep bonds stir feelings.','["Review one subscription","Journal a fear→fact","Safeguard a password"]'),
('planet_in_house','moon_house_9','Moon in House IX','Beliefs and far horizons lift spirits.','["Learn a worldview snippet","Explore a map","Say yes to a new idea"]'),
('planet_in_house','moon_house_10','Moon in House X','Visibility and role affect mood.','["Define today’s win","Polish a profile line","Celebrate a micro‑result"]'),
('planet_in_house','moon_house_11','Moon in House XI','Friends and causes nurture you.','["Post a helpful tip","Thank a collaborator","Join a community thread"]'),
('planet_in_house','moon_house_12','Moon in House XII','Solitude and inner life soothe.','["Mute notifications 20m","Write a worry→action","Rest without screens"]');


-- MERCURY in HOUSES (12)
insert into public.interpretations (type, key, title, summary, tips) values
('planet_in_house','mercury_house_1','Mercury in House I','Quick mind; you lead with words and ideas.','["Draft a 2‑sentence bio","Outline before writing","Ask one smart question"]'),
('planet_in_house','mercury_house_2','Mercury in House II','Thinking about value, skills and income.','["Note one marketable skill","Track a micro‑expense","Pitch a tiny service"]'),
('planet_in_house','mercury_house_3','Mercury in House III','Curious messenger; short trips, siblings, notes.','["Try a new note method","Walk & record a thought","Reply to one email well"]'),
('planet_in_house','mercury_house_4','Mercury in House IV','Family stories and home logistics.','["Label a box","Map a home task","Call a relative"]'),
('planet_in_house','mercury_house_5','Mercury in House V','Creative mind and witty play.','["Brainstorm 10 ideas","Write a limerick","Explain a concept simply"]'),
('planet_in_house','mercury_house_6','Mercury in House VI','Process thinker; systems and health routines.','["Template a checklist","Rename files clearly","Schedule admin block"]'),
('planet_in_house','mercury_house_7','Mercury in House VII','Dialog and negotiation skills.','["Mirror back what you heard","Draft a simple contract","Clarify expectations"]'),
('planet_in_house','mercury_house_8','Mercury in House VIII','Research mind; shared finances, psychology.','["Read a summary on a taboo topic","Review a shared bill","Use a password manager"]'),
('planet_in_house','mercury_house_9','Mercury in House IX','Philosophy, teaching and publishing.','["Write a thread outline","Teach one idea to a friend","Skim a research abstract"]'),
('planet_in_house','mercury_house_10','Mercury in House X','Career communication and strategy.','["Update a headline","Draft next-step email","Define success metric"]'),
('planet_in_house','mercury_house_11','Mercury in House XI','Networks, groups and future plans.','["Map 3 contacts","Share a resource","Set a quarterly theme"]'),
('planet_in_house','mercury_house_12','Mercury in House XII','Inner dialogue, analysis in quiet.','["Morning pages 5 min","Name a limiting story","Plan a rest ritual"]');


-- TRANSIT → NATAL (12 examples)
insert into public.interpretations (type, key, title, summary, tips) values
('transit_to_nat','tr_sun_conj_moon','Transit Sun conjunct natal Moon','Daily spotlight meets feelings: clarity about needs.','["Name the top need today","Share it gently","Protect energy early"]'),
('transit_to_nat','tr_venus_trine_sun','Transit Venus trine natal Sun','Ease in connections and taste; pleasant flow for expression.','["Plan a social coffee","Tweak a design detail","Offer appreciation"]'),
('transit_to_nat','tr_mars_square_moon','Transit Mars square natal Moon','Irritability possible; act, don’t react.','["Move your body 10 min","Count to 10 before replying","Channel into a task"]'),
('transit_to_nat','tr_mercury_sextile_mc','Transit Mercury sextile natal MC','Useful news for career/role; small wins via message.','["Send a concise update","Polish one slide","Follow up on a lead"]'),
('transit_to_nat','tr_jupiter_trine_asc','Transit Jupiter trine natal ASC','Confidence and support expand; helpful allies appear.','["Ask for intro","Schedule growth task","Celebrate a small luck"]'),
('transit_to_nat','tr_saturn_opposition_sun','Transit Saturn opposite natal Sun','Reality check and responsibility; long‑term focus.','["Define a boundary","Commit to a schedule","Remove one distraction"]'),
('transit_to_nat','tr_uranus_square_venus','Transit Uranus square natal Venus','Surprises in taste/relationships; update patterns.','["Try a fresh style","Plan a novelty date","Unsubscribe from clutter"]'),
('transit_to_nat','tr_neptune_trine_moon','Transit Neptune trine natal Moon','Soft imagination and empathy; rest supports insight.','["Short meditation","Art playlist","Dream journal note"]'),
('transit_to_nat','tr_pluto_conj_mc','Transit Pluto conjunct natal MC','Powerful career transformation; go deep and strategic.','["Audit your goals","Protect reputation","Find a mentor"]'),
('transit_to_nat','tr_mars_sextile_mercury','Transit Mars sextile natal Mercury','Quick action + clear words; ship small decisions.','["Timebox a task","Send decisive email","Avoid doomscrolling"]'),
('transit_to_nat','tr_sun_square_saturn','Transit Sun square natal Saturn','Friction shows limits → structure helps.','["Break task into 3","Ask for clarity","Rest on time"]'),
('transit_to_nat','tr_venus_opposition_mars','Transit Venus opposite natal Mars','Attraction vs. assertion dynamics; balance charm and drive.','["Plan a fair compromise","Compliment + ask","Cool down before reacting"]');
```


## File: tailwind.config.ts

```ts
import type { Config } from 'tailwindcss'


const config: Config = {
content: [
'./src/pages/**/*.{js,ts,jsx,tsx,mdx}',
'./src/components/**/*.{js,ts,jsx,tsx,mdx}',
'./src/app/**/*.{js,ts,jsx,tsx,mdx}',
],
theme: {
extend: {
colors: {
brand: {
50: '#eef6ff',
100: '#d9ebff',
200: '#b7d8ff',
300: '#8bbfff',
400: '#5ea2ff',
500: '#3a86ff',
600: '#2367db',
700: '#1a4faa',
800: '#173f87',
900: '#142f66'
}
}
}
},
plugins: []
}


export default config
```


## File: tsconfig.json

```json
{
  "compilerOptions": {
    "target": "es2020",
    "lib": [
      "dom",
      "dom.iterable",
      "es2020"
    ],
    "allowJs": false,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./src/*"
      ]
    },
    "incremental": true
  },
  "include": [
    "**/*.ts",
    "**/*.tsx",
    "next-env.d.ts",
    ".next/types/**/*.ts"
, "next.config.msj"  ],
  "exclude": [
    "node_modules"
  ]
}

```
